syntax = "proto3";

package api.v1;

option go_package = "QuotaLane/api/v1;v1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "validate/validate.proto";

// AccountService 账号池管理服务
// 提供AI账号的CRUD操作、Token刷新和健康检测功能
// 所有操作使用扁平化的路径设计，路径即操作名
service AccountService {
  // CreateAccount 创建新账号
  rpc CreateAccount(CreateAccountRequest) returns (CreateAccountResponse) {
    option (google.api.http) = {
      post: "/CreateAccount"
      body: "*"
    };
  }

  // ListAccounts 查询账号列表
  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse) {
    option (google.api.http) = {
      post: "/ListAccounts"
      body: "*"
    };
  }

  // GetAccount 获取账号详情
  rpc GetAccount(GetAccountRequest) returns (GetAccountResponse) {
    option (google.api.http) = {
      post: "/GetAccount"
      body: "*"
    };
  }

  // UpdateAccount 更新账号信息
  rpc UpdateAccount(UpdateAccountRequest) returns (UpdateAccountResponse) {
    option (google.api.http) = {
      post: "/UpdateAccount"
      body: "*"
    };
  }

  // DeleteAccount 删除账号
  rpc DeleteAccount(DeleteAccountRequest) returns (DeleteAccountResponse) {
    option (google.api.http) = {
      post: "/DeleteAccount"
      body: "*"
    };
  }

  // RefreshToken 刷新OAuth Token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/RefreshToken"
      body: "*"
    };
  }

  // TestAccount 测试账号连通性和健康度
  rpc TestAccount(TestAccountRequest) returns (TestAccountResponse) {
    option (google.api.http) = {
      post: "/TestAccount"
      body: "*"
    };
  }

  // ========== 统一 OAuth 授权流程（支持多平台）==========

  // GenerateOAuthURL 生成 OAuth 授权 URL（统一接口）
  rpc GenerateOAuthURL(GenerateOAuthURLRequest) returns (GenerateOAuthURLResponse) {
    option (google.api.http) = {
      post: "/GenerateOAuthURL"
      body: "*"
    };
  }

  // ExchangeOAuthCode 交换 OAuth 授权码（统一接口）
  rpc ExchangeOAuthCode(ExchangeOAuthCodeRequest) returns (ExchangeOAuthCodeResponse) {
    option (google.api.http) = {
      post: "/ExchangeOAuthCode"
      body: "*"
    };
  }

  // PollOAuthStatus 轮询 OAuth 授权状态（Device Flow 预留接口）
  rpc PollOAuthStatus(PollOAuthStatusRequest) returns (PollOAuthStatusResponse) {
    option (google.api.http) = {
      post: "/PollOAuthStatus"
      body: "*"
    };
  }

  // ResetHealthScore 重置账号健康分数（管理员操作）
  rpc ResetHealthScore(ResetHealthScoreRequest) returns (ResetHealthScoreResponse) {
    option (google.api.http) = {
      post: "/ResetHealthScore"
      body: "*"
    };
  }

  // ========== Story 2.6: 账户组管理 ==========

  // CreateAccountGroup 创建账户组
  rpc CreateAccountGroup(CreateAccountGroupRequest) returns (CreateAccountGroupResponse) {
    option (google.api.http) = {
      post: "/CreateAccountGroup"
      body: "*"
    };
  }

  // ListAccountGroups 查询账户组列表
  rpc ListAccountGroups(ListAccountGroupsRequest) returns (ListAccountGroupsResponse) {
    option (google.api.http) = {
      post: "/ListAccountGroups"
      body: "*"
    };
  }

  // GetAccountGroup 获取账户组详情（包含账户详情）
  rpc GetAccountGroup(GetAccountGroupRequest) returns (GetAccountGroupResponse) {
    option (google.api.http) = {
      post: "/GetAccountGroup"
      body: "*"
    };
  }

  // UpdateAccountGroup 更新账户组
  rpc UpdateAccountGroup(UpdateAccountGroupRequest) returns (UpdateAccountGroupResponse) {
    option (google.api.http) = {
      post: "/UpdateAccountGroup"
      body: "*"
    };
  }

  // DeleteAccountGroup 删除账户组（软删除）
  rpc DeleteAccountGroup(DeleteAccountGroupRequest) returns (DeleteAccountGroupResponse) {
    option (google.api.http) = {
      post: "/DeleteAccountGroup"
      body: "*"
    };
  }
}

// AccountProvider AI服务提供商枚举
enum AccountProvider {
  ACCOUNT_PROVIDER_UNSPECIFIED = 0;
  CLAUDE_OFFICIAL = 1;       // Claude官方账户
  CLAUDE_CONSOLE = 2;        // Claude Console账户
  BEDROCK = 3;               // AWS Bedrock
  CCR = 4;                   // CCR账户
  DROID = 5;                 // Droid (Factory.ai)
  GEMINI = 6;                // Google Gemini
  OPENAI_RESPONSES = 7;      // OpenAI Responses (Codex)
  AZURE_OPENAI = 8;          // Azure OpenAI
  CODEX_CLI = 9;             // Codex CLI (OAuth)
}

// AccountStatus 账户状态枚举
enum AccountStatus {
  ACCOUNT_STATUS_UNSPECIFIED = 0;
  ACCOUNT_ACTIVE = 1;     // 活跃状态
  ACCOUNT_INACTIVE = 2;   // 未激活
  ACCOUNT_ERROR = 3;      // 错误状态
  ACCOUNT_CREATED = 4;    // 已创建但未验证（用于 OAuth 流程）
}

// Account 账号信息
message Account {
  int64 Id = 1;                                 // 账户ID
  string Name = 2;                              // 账户名称
  AccountProvider Provider = 3;                 // 服务提供商
  string ApiKeyEncrypted = 4;                   // 加密的API Key
  string OAuthDataEncrypted = 5;                // 加密的OAuth数据（JSON格式）
  int32 RpmLimit = 6;                           // 每分钟请求数限制
  int32 TpmLimit = 7;                           // 每分钟Token数限制
  int32 HealthScore = 8;                        // 健康分数（0-100）
  bool IsCircuitBroken = 9;                     // 是否熔断
  AccountStatus Status = 10;                    // 账户状态
  string Metadata = 11;                         // 扩展元数据（JSON格式：代理配置、区域等）
  google.protobuf.Timestamp CreatedAt = 12;     // 创建时间
  google.protobuf.Timestamp UpdatedAt = 13;     // 更新时间
  google.protobuf.Timestamp OAuthExpiresAt = 14;  // OAuth Token 过期时间（可为空）
}

// CreateAccountRequest 创建账号请求
message CreateAccountRequest {
  string Name = 1 [(validate.rules).string = {min_len: 1, max_len: 100}];  // 账户名称（必填）
  AccountProvider Provider = 2 [(validate.rules).enum = {defined_only: true, not_in: [0]}];  // 服务提供商（必填）
  string ApiKey = 3;              // API Key（明文，服务端会加密存储）
  string OAuthData = 4;           // OAuth数据（JSON格式，明文，服务端会加密存储）
  int32 RpmLimit = 5 [(validate.rules).int32 = {gte: 0}];  // 每分钟请求数限制
  int32 TpmLimit = 6 [(validate.rules).int32 = {gte: 0}];  // 每分钟Token数限制
  string Metadata = 7;             // 扩展元数据（JSON格式）
}

// CreateAccountResponse 创建账号响应
message CreateAccountResponse {
  Account Account = 1;  // 创建的账号信息
}

// ListAccountsRequest 查询账号列表请求
message ListAccountsRequest {
  int32 Page = 1 [(validate.rules).int32 = {gte: 1}];        // 页码（从1开始）
  int32 PageSize = 2 [(validate.rules).int32 = {gte: 1, lte: 100}];  // 每页数量（1-100）
  AccountProvider Provider = 3;   // 按提供商过滤（可选）
  AccountStatus Status = 4;       // 按状态过滤（可选）
}

// ListAccountsResponse 查询账号列表响应
message ListAccountsResponse {
  repeated Account Accounts = 1;  // 账号列表
  int32 Total = 2;                // 总数量
  int32 Page = 3;                 // 当前页码
  int32 PageSize = 4;             // 每页数量
}

// GetAccountRequest 获取账号详情请求
message GetAccountRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户ID（必填）
}

// GetAccountResponse 获取账号详情响应
message GetAccountResponse {
  Account Account = 1;  // 账号信息
}

// UpdateAccountRequest 更新账号信息请求
message UpdateAccountRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户ID（必填）
  optional string Name = 2 [(validate.rules).string = {max_len: 100}];  // 账户名称（可选）
  optional string ApiKey = 3;           // API Key（明文，服务端会加密存储）（可选）
  optional string OAuthData = 4;        // OAuth数据（JSON格式）（可选）
  optional int32 RpmLimit = 5 [(validate.rules).int32 = {gte: 0}];  // RPM限制（可选）
  optional int32 TpmLimit = 6 [(validate.rules).int32 = {gte: 0}];  // TPM限制（可选）
  optional AccountStatus Status = 7;     // 账户状态（可选）
  optional string Metadata = 8;          // 扩展元数据（JSON格式）（可选）
}

// UpdateAccountResponse 更新账号信息响应
message UpdateAccountResponse {
  Account Account = 1;  // 更新后的账号信息
}

// DeleteAccountRequest 删除账号请求
message DeleteAccountRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户ID（必填）
}

// DeleteAccountResponse 删除账号响应
message DeleteAccountResponse {
  bool Success = 1;  // 是否成功
  string Message = 2;  // 提示信息
}

// RefreshTokenRequest 刷新Token请求
message RefreshTokenRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户ID（必填）
}

// RefreshTokenResponse 刷新Token响应
message RefreshTokenResponse {
  bool Success = 1;  // 是否成功
  string Message = 2;  // 提示信息
  google.protobuf.Timestamp ExpiresAt = 3;  // Token过期时间
}

// TestAccountRequest 测试账号请求
message TestAccountRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户ID（必填）
}

// TestAccountResponse 测试账号响应
message TestAccountResponse {
  bool Success = 1;           // 是否测试成功
  string Message = 2;         // 测试结果消息
  int32 HealthScore = 3;      // 健康分数（0-100）
  int32 ResponseTimeMs = 4;   // 响应时间（毫秒）
}

// ========== 统一 OAuth 授权流程消息定义 ==========

// ProxyConfig 代理配置
message ProxyConfig {
  string Url = 1;                 // 代理 URL（socks5:// 或 http://）
  optional string Username = 2;   // 代理用户名（可选）
  optional string Password = 3;   // 代理密码（可选）
}

// GenerateOAuthURLRequest 生成 OAuth 授权 URL 请求
message GenerateOAuthURLRequest {
  AccountProvider Provider = 1 [(validate.rules).enum = {defined_only: true, not_in: [0]}];  // OAuth Provider（必填）
  optional ProxyConfig Proxy = 2;           // 请求级代理配置（优先级最高）（可选）
  optional string RedirectUri = 3;         // 自定义重定向 URI（可选）
  repeated string Scopes = 4;               // 自定义 scopes（可选）
  map<string, string> Metadata = 5;         // 额外元数据（可选）
}

// GenerateOAuthURLResponse 生成 OAuth 授权 URL 响应
message GenerateOAuthURLResponse {
  string AuthUrl = 1;              // 授权 URL（用户需要访问此 URL 完成授权）
  string SessionId = 2;            // 会话 ID（用于后续交换授权码）
  string State = 3;                 // CSRF 防护 state 参数（客户端需验证）

  // Device Flow 字段（预留）
  optional string DeviceCode = 4;       // 设备码（后端轮询用）
  optional string UserCode = 5;         // 用户码（用户输入用）
  optional string VerificationUri = 6;  // 验证 URI（用户访问此 URL 输入 UserCode）
  optional int32 ExpiresIn = 7;         // Device Code 过期时间（秒）
  optional int32 Interval = 8;           // 轮询间隔（秒）
}

// ExchangeOAuthCodeRequest 交换 OAuth 授权码请求
message ExchangeOAuthCodeRequest {
  string SessionId = 1 [(validate.rules).string = {min_len: 1}];  // 会话 ID（必填）
  string Code = 2 [(validate.rules).string = {min_len: 1}];        // 授权码（必填）
  string Name = 3 [(validate.rules).string = {min_len: 1, max_len: 100}];  // 账户名称（必填）
  optional string Description = 4 [(validate.rules).string = {max_len: 500}];  // 账户描述（可选）
  optional int32 RpmLimit = 5 [(validate.rules).int32 = {gte: 0}];  // RPM 限制（可选）
  optional int32 TpmLimit = 6 [(validate.rules).int32 = {gte: 0}];  // TPM 限制（可选）
  map<string, string> Metadata = 7;  // 扩展元数据（可选）
}

// ExchangeOAuthCodeResponse 交换 OAuth 授权码响应
message ExchangeOAuthCodeResponse {
  int64 AccountId = 1;       // 创建的账户 ID
  string AccountName = 2;    // 账户名称
  AccountStatus Status = 3;   // 账户状态
  string Message = 4;         // 提示信息
  google.protobuf.Timestamp TokenExpiresAt = 5;  // Access token 过期时间
}

// OAuthStatusEnum OAuth 授权状态枚举
enum OAuthStatusEnum {
  OAUTH_STATUS_UNSPECIFIED = 0;
  OAUTH_PENDING = 1;      // 等待授权
  OAUTH_COMPLETED = 2;    // 授权成功
  OAUTH_EXPIRED = 3;      // 超时
  OAUTH_DENIED = 4;       // 拒绝
}

// PollOAuthStatusRequest 轮询 OAuth 授权状态请求（Device Flow 预留）
message PollOAuthStatusRequest {
  string SessionId = 1 [(validate.rules).string = {min_len: 1}];  // 会话 ID（必填）
}

// PollOAuthStatusResponse 轮询 OAuth 授权状态响应（Device Flow 预留）
message PollOAuthStatusResponse {
  bool Completed = 1;              // 是否完成
  OAuthStatusEnum Status = 2;      // 授权状态
  string Message = 3;              // 提示信息
  optional int64 AccountId = 4;    // 账户 ID（授权成功时返回）
}

// ========== Story 2.5: 健康分数和熔断机制 ==========

// ResetHealthScoreRequest 重置账号健康分数请求
message ResetHealthScoreRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户 ID（必填，> 0）
}

// ResetHealthScoreResponse 重置账号健康分数响应
message ResetHealthScoreResponse {
  Account Account = 1;  // 更新后的账户信息
}

// ========== Story 2.6: 账户组管理消息定义 ==========

// AccountGroup 账户组信息
message AccountGroup {
  int64 Id = 1;                                 // 账户组ID
  string Name = 2;                              // 组名称
  string Description = 3;                       // 组描述
  int32 Priority = 4;                           // 优先级（数字越大优先级越高）
  repeated int64 AccountIds = 5;                // 账户ID列表
  google.protobuf.Timestamp CreatedAt = 6;      // 创建时间
  google.protobuf.Timestamp UpdatedAt = 7;      // 更新时间
}

// CreateAccountGroupRequest 创建账户组请求
message CreateAccountGroupRequest {
  string Name = 1 [(validate.rules).string = {min_len: 1, max_len: 100}];  // 组名称（必填，1-100字符）
  string Description = 2;                        // 组描述（可选）
  int32 Priority = 3 [(validate.rules).int32 = {gte: 0}];  // 优先级（可选，默认0）
  repeated int64 AccountIds = 4;                 // 账户ID列表（可选）
}

// CreateAccountGroupResponse 创建账户组响应
message CreateAccountGroupResponse {
  AccountGroup Group = 1;  // 创建的账户组信息
}

// ListAccountGroupsRequest 查询账户组列表请求
message ListAccountGroupsRequest {
  int32 Page = 1 [(validate.rules).int32 = {gte: 1}];              // 页码（从1开始）
  int32 PageSize = 2 [(validate.rules).int32 = {gte: 1, lte: 100}];  // 每页数量（1-100）
}

// ListAccountGroupsResponse 查询账户组列表响应
message ListAccountGroupsResponse {
  repeated AccountGroup Groups = 1;  // 账户组列表
  int64 Total = 2;                   // 总数量
  int32 Page = 3;                    // 当前页码
  int32 PageSize = 4;                // 每页数量
}

// GetAccountGroupRequest 获取账户组详情请求
message GetAccountGroupRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户组ID（必填，> 0）
}

// GetAccountGroupResponse 获取账户组详情响应
message GetAccountGroupResponse {
  AccountGroup Group = 1;            // 账户组信息
  repeated Account Accounts = 2;     // 账户详情列表（包含组内所有账户）
}

// UpdateAccountGroupRequest 更新账户组请求
message UpdateAccountGroupRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户组ID（必填，> 0）
  optional string Name = 2 [(validate.rules).string = {max_len: 100}];  // 组名称（可选）
  optional string Description = 3;    // 组描述（可选）
  optional int32 Priority = 4 [(validate.rules).int32 = {gte: 0}];  // 优先级（可选）
  repeated int64 AccountIds = 5;      // 账户ID列表（可选，传空数组清空成员）
}

// UpdateAccountGroupResponse 更新账户组响应
message UpdateAccountGroupResponse {
  AccountGroup Group = 1;  // 更新后的账户组信息
}

// DeleteAccountGroupRequest 删除账户组请求
message DeleteAccountGroupRequest {
  int64 Id = 1 [(validate.rules).int64 = {gt: 0}];  // 账户组ID（必填，> 0）
}

// DeleteAccountGroupResponse 删除账户组响应
message DeleteAccountGroupResponse {
  bool Success = 1;  // 是否成功
  string Message = 2;  // 提示信息
}
