syntax = "proto3";

package api.v1;

option go_package = "QuotaLane/api/v1;v1";

import "google/api/annotations.proto";
import "validate/validate.proto";

// GatewayService API网关服务
// 提供统一的AI API调用接口，完全兼容Anthropic API格式
service GatewayService {
  // CreateMessage 创建消息（支持流式响应）
  // 兼容Anthropic Messages API格式
  rpc CreateMessage(CreateMessageRequest) returns (stream MessageChunk) {
    option (google.api.http) = {
      post: "/v1/messages"
      body: "*"
    };
  }

  // CountTokens 统计消息的Token数量（Beta API）
  rpc CountTokens(CountTokensRequest) returns (CountTokensResponse) {
    option (google.api.http) = {
      post: "/v1/messages/count_tokens"
      body: "*"
    };
  }

  // ListModels 获取可用模型列表
  rpc ListModels(ListModelsRequest) returns (ListModelsResponse) {
    option (google.api.http) = {
      get: "/v1/models"
    };
  }
}

// Message 消息结构
message Message {
  string Role = 1 [(validate.rules).string = {in: ["user", "assistant"]}];  // 角色：user 或 assistant
  string Content = 2 [(validate.rules).string = {min_len: 1}];  // 消息内容（必填）
}

// CreateMessageRequest 创建消息请求
message CreateMessageRequest {
  string Model = 1 [(validate.rules).string = {min_len: 1}];  // 模型名称（必填，如 claude-3-5-sonnet-20241022）
  repeated Message Messages = 2 [(validate.rules).repeated = {min_items: 1}];  // 消息列表（必填，至少1条）
  int32 MaxTokens = 3 [(validate.rules).int32 = {gt: 0, lte: 8192}];  // 最大输出tokens（必填，1-8192）
  optional string System = 4;  // 系统提示词（可选）
  optional float Temperature = 5 [(validate.rules).float = {gte: 0.0, lte: 1.0}];  // 温度参数（可选，0.0-1.0）
  optional float TopP = 6 [(validate.rules).float = {gte: 0.0, lte: 1.0}];  // Top-P采样（可选，0.0-1.0）
  optional int32 TopK = 7 [(validate.rules).int32 = {gte: 0}];  // Top-K采样（可选）
  bool Stream = 8;  // 是否流式输出（默认false）
  repeated string StopSequences = 9;  // 停止序列（可选）
  map<string, string> Metadata = 10;  // 元数据（可选）
}

// MessageChunk 流式响应数据块
message MessageChunk {
  string Type = 1;  // 事件类型：message_start, content_block_start, content_block_delta, content_block_stop, message_delta, message_stop
  string Id = 2;  // 消息ID
  string Model = 3;  // 使用的模型
  string Role = 4;  // 角色（assistant）
  repeated ContentBlock Content = 5;  // 内容块列表
  string StopReason = 6;  // 停止原因：end_turn, max_tokens, stop_sequence
  Usage Usage = 7;  // Token使用统计
  int32 Index = 8;  // 内容块索引
  Delta Delta = 9;  // 增量数据
}

// ContentBlock 内容块
message ContentBlock {
  string Type = 1;  // 内容类型：text
  string Text = 2;  // 文本内容
}

// Delta 增量数据
message Delta {
  string Type = 1;  // 类型：text_delta
  string Text = 2;  // 增量文本
  string StopReason = 3;  // 停止原因
  Usage Usage = 4;  // 使用统计增量
}

// Usage Token使用统计
message Usage {
  int32 InputTokens = 1;  // 输入tokens
  int32 OutputTokens = 2;  // 输出tokens
  int32 CacheCreationInputTokens = 3;  // 缓存创建tokens
  int32 CacheReadInputTokens = 4;  // 缓存读取tokens
}

// CreateMessageResponse 创建消息响应（非流式）
message CreateMessageResponse {
  string Id = 1;  // 消息ID
  string Type = 2;  // 类型：message
  string Model = 3;  // 使用的模型
  string Role = 4;  // 角色（assistant）
  repeated ContentBlock Content = 5;  // 内容列表
  string StopReason = 6;  // 停止原因
  Usage Usage = 7;  // Token使用统计
}

// CountTokensRequest Token计数请求
message CountTokensRequest {
  string Model = 1 [(validate.rules).string = {min_len: 1}];  // 模型名称（必填）
  repeated Message Messages = 2 [(validate.rules).repeated = {min_items: 1}];  // 消息列表（必填）
  optional string System = 3;  // 系统提示词（可选）
}

// CountTokensResponse Token计数响应
message CountTokensResponse {
  int32 InputTokens = 1;  // 输入tokens总数
}

// ListModelsRequest 模型列表请求
message ListModelsRequest {
  // 暂无查询参数
}

// Model 模型信息
message Model {
  string Id = 1;  // 模型ID（如 claude-3-5-sonnet-20241022）
  string Name = 2;  // 模型名称
  string Description = 3;  // 模型描述
  int32 MaxTokens = 4;  // 最大tokens
  repeated string Capabilities = 5;  // 能力列表（vision, streaming等）
}

// ListModelsResponse 模型列表响应
message ListModelsResponse {
  repeated Model Models = 1;  // 模型列表
}
